<html>
    <body>
        <h2>Search</h2>
        <form method="GET" action="search.php"> 
            <input type="hidden" id="project-selectQueryRequest" name="project-selectQueryRequest">
            <label for="table">Table Select:</label>
            <select id="table" name="TableType">
                <option value="Buy">Buy</option>
                <option value="Cafe">Cafe</option>
                <option value="ClassHeldIn1">ClassHeldIn1</option>
                <option value="ClassHeldIn2">ClassHeldIn2</option>
                <option value="EmployeesWorkingIn">EmployeesWorkingIn</option>
                <option value="EventHall1">EventHall1</option>
                <option value="EventHall2">EventHall2</option>
                <option value="Events">Events</option>
                <option value="Facilities">Facilities</option>
                <option value="Gym">Gym</option>
                <option value="HeldIn">HeldIn</option>
                <option value="Issue">Issue</option>
                <option value="Maintain">Maintain</option>
                <option value="MenuItem">MenuItem</option>
                <option value="RecPass">RecPass</option>
                <option value="RentalEquipment">RentalEquipment</option>
                <option value="Users">Users</option>
            </select> <br /><br />
            <label for="attribute1">Attribute 1 Select:</label>
            <select id="attribute1" name="Attribute1Type">
                <option value="None">None</option>
                <option value="ADDRESS">Address</option>
                <option value="CAFEID">CafeID</option>
                <option value="CLASSNAME">Classname</option>
                <option value="CLASSTYPE">Classtype</option>
                <option value="DAY">Day</option>
                <option value="EMPLOYEESIN">Employeesin</option>
                <option value="EQUIPMENTID">EquipmentID</option>
                <option value="EVENTID">EventID</option>
                <option value="ISSUEDATE">Issuedate</option>
                <option value="LENGTH">Length</option>
                <option value="MAXOCCUPANCY">Maxoccupancy</option>
                <option value="MEMBERID">MemberID</option>
                <option value="MENUITEMTYPE">Menuitemtype</option>
                <option value="NAME">Name</option>
                <option value="PRICE">Price</option>
                <option value="RECPASSLENGTH">Recpasslength</option>
                <option value="RECPASSTYPE">Recpasstype</option>
                <option value="RENTALLENGTH">RentalLength</option>
                <option value="ROOMNUM">RoomNum</option>
                <option value="SIN">Sin</option>
                <option value="SIZEINSQFT">Sizeinsqft</option>
                <option value="STATUS">Status</option>
                <option value="TYPE">Type</option>
                <option value="TYPES">Types</option>
                <option value="USERID">Userid</option>
            </select> <br /><br />
            <label for="attribute2">Attribute 2 Select:</label>
            <select id="attribute2" name="Attribute2Type">
                <option value="None">None</option>
                <option value="ADDRESS">Address</option>
                <option value="CAFEID">CafeID</option>
                <option value="CLASSNAME">Classname</option>
                <option value="CLASSTYPE">Classtype</option>
                <option value="DAY">Day</option>
                <option value="EMPLOYEESIN">Employeesin</option>
                <option value="EQUIPMENTID">EquipmentID</option>
                <option value="EVENTID">EventID</option>
                <option value="ISSUEDATE">Issuedate</option>
                <option value="LENGTH">Length</option>
                <option value="MAXOCCUPANCY">Maxoccupancy</option>
                <option value="MEMBERID">MemberID</option>
                <option value="MENUITEMTYPE">Menuitemtype</option>
                <option value="NAME">Name</option>
                <option value="PRICE">Price</option>
                <option value="RECPASSLENGTH">Recpasslength</option>
                <option value="RECPASSTYPE">Recpasstype</option>
                <option value="RENTALLENGTH">RentalLength</option>
                <option value="ROOMNUM">RoomNum</option>
                <option value="SIN">Sin</option>
                <option value="SIZEINSQFT">Sizeinsqft</option>
                <option value="STATUS">Status</option>
                <option value="TYPE">Type</option>
                <option value="TYPES">Types</option>
                <option value="USERID">Userid</option>
            </select> <br /><br />
            <label for="attribute3">Attribute 3 Select:</label>
            <select id="attribute3" name="Attribute3Type">
                <option value="None">None</option>
                <option value="ADDRESS">Address</option>
                <option value="CAFEID">CafeID</option>
                <option value="CLASSNAME">Classname</option>
                <option value="CLASSTYPE">Classtype</option>
                <option value="DAY">Day</option>
                <option value="EMPLOYEESIN">Employeesin</option>
                <option value="EQUIPMENTID">EquipmentID</option>
                <option value="EVENTID">EventID</option>
                <option value="ISSUEDATE">Issuedate</option>
                <option value="LENGTH">Length</option>
                <option value="MAXOCCUPANCY">Maxoccupancy</option>
                <option value="MEMBERID">MemberID</option>
                <option value="MENUITEMTYPE">Menuitemtype</option>
                <option value="NAME">Name</option>
                <option value="PRICE">Price</option>
                <option value="RECPASSLENGTH">Recpasslength</option>
                <option value="RECPASSTYPE">Recpasstype</option>
                <option value="RENTALLENGTH">RentalLength</option>
                <option value="ROOMNUM">RoomNum</option>
                <option value="SIN">Sin</option>
                <option value="SIZEINSQFT">Sizeinsqft</option>
                <option value="STATUS">Status</option>
                <option value="TYPE">Type</option>
                <option value="TYPES">Types</option>
                <option value="USERID">Userid</option>
            </select> <br /><br />
            <label for="attribute4">Attribute 4 Select:</label>
            <select id="attribute4" name="Attribute4Type">
                <option value="None">None</option>
                <option value="ADDRESS">Address</option>
                <option value="CAFEID">CafeID</option>
                <option value="CLASSNAME">Classname</option>
                <option value="CLASSTYPE">Classtype</option>
                <option value="DAY">Day</option>
                <option value="EMPLOYEESIN">Employeesin</option>
                <option value="EQUIPMENTID">EquipmentID</option>
                <option value="EVENTID">EventID</option>
                <option value="ISSUEDATE">Issuedate</option>
                <option value="LENGTH">Length</option>
                <option value="MAXOCCUPANCY">Maxoccupancy</option>
                <option value="MEMBERID">MemberID</option>
                <option value="MENUITEMTYPE">Menuitemtype</option>
                <option value="NAME">Name</option>
                <option value="PRICE">Price</option>
                <option value="RECPASSLENGTH">Recpasslength</option>
                <option value="RECPASSTYPE">Recpasstype</option>
                <option value="RENTALLENGTH">RentalLength</option>
                <option value="ROOMNUM">RoomNum</option>
                <option value="SIN">Sin</option>
                <option value="SIZEINSQFT">Sizeinsqft</option>
                <option value="STATUS">Status</option>
                <option value="TYPE">Type</option>
                <option value="TYPES">Types</option>
                <option value="USERID">Userid</option>
            </select> <br /><br />
            <label for="attribute5">Attribute 5 Select:</label>
            <select id="attribute5" name="Attribute5Type">
                <option value="None">None</option>
                <option value="ADDRESS">Address</option>
                <option value="CAFEID">CafeID</option>
                <option value="CLASSNAME">Classname</option>
                <option value="CLASSTYPE">Classtype</option>
                <option value="DAY">Day</option>
                <option value="EMPLOYEESIN">Employeesin</option>
                <option value="EQUIPMENTID">EquipmentID</option>
                <option value="EVENTID">EventID</option>
                <option value="ISSUEDATE">Issuedate</option>
                <option value="LENGTH">Length</option>
                <option value="MAXOCCUPANCY">Maxoccupancy</option>
                <option value="MEMBERID">MemberID</option>
                <option value="MENUITEMTYPE">Menuitemtype</option>
                <option value="NAME">Name</option>
                <option value="PRICE">Price</option>
                <option value="RECPASSLENGTH">Recpasslength</option>
                <option value="RECPASSTYPE">Recpasstype</option>
                <option value="RENTALLENGTH">RentalLength</option>
                <option value="ROOMNUM">RoomNum</option>
                <option value="SIN">Sin</option>
                <option value="SIZEINSQFT">Sizeinsqft</option>
                <option value="STATUS">Status</option>
                <option value="TYPE">Type</option>
                <option value="TYPES">Types</option>
                <option value="USERID">Userid</option>
            </select> <br /><br />
            Enter text into text space below to search attributes for attributes with matching text (Selection) <br /><br />
            Leave text space empty to find all items that fufill table and attribute requirements (Projection)
            <br /><br />
            Find Attribute 1: <input type="text" name="Input1"> <br /><br /> 
            Find Attribute 2: <input type="text" name="Input2"> <br /><br />
            Find Attribute 3: <input type="text" name="Input3"> <br /><br />
            Find Attribute 4: <input type="text" name="Input4"> <br /><br />
            Find Attribute 5: <input type="text" name="Input5"> <br /><br />
            <input type="submit" value="Search" name="project-select"></p>
        </form>
        <h2>Navigation</h2>
        <button onclick="location.href='304project.php'">Home</button>
        <br><br>
        <button onclick="location.href='cafe.php'">Cafe</button>
        <br><br>
        <button onclick="location.href='loginpage.php'">Logout</button>



    </body>
    <?php
        function handlePSRequest() {
            global $db_conn;
            $Table = $_GET['TableType'];
            $Attribute1 =  $_GET['Attribute1Type'];
            $Attribute2 =  $_GET['Attribute2Type'];
            $Attribute3 =  $_GET['Attribute3Type'];
            $Attribute4 =  $_GET['Attribute4Type'];
            $Attribute5 =  $_GET['Attribute5Type'];
            $attr_arr = array( $Attribute1 , $Attribute2 , $Attribute3 , $Attribute4 , $Attribute5 );
            $Compare1 = $_GET['Input1'];
            $Compare2 = $_GET['Input2'];
            $Compare3 = $_GET['Input3'];
            $Compare4 = $_GET['Input4'];
            $Compare5 = $_GET['Input5'];

            if ($Attribute1 == "None" && $Attribute2 == "None" && $Attribute3 == "None" && $Attribute4 == "None" && $Attribute5 == "None") {
                echo "Please select attributes";
            } else if ($Compare1 == "" && $Compare2 == "" && $Compare3 == "" && $Compare4 == "" && $Compare5 == "") {
                // Projection
                $result = executePlainSQL("SELECT * FROM $Table");
                printProjection($attr_arr, $Table);
            } else{
                //Selection
                $comp_arr = array($Compare1,$Compare2,$Compare3,$Compare4,$Compare5);
                printSelection($result, $attr_arr, $Table, $comp_arr);
            }
            OCICommit($db_conn);
        }
        
        function executePlainSQL($cmdstr) { //takes a plain (no bound variables) SQL command and executes it
            global $db_conn, $success;

            $statement = OCIParse($db_conn, $cmdstr);

            if (!$statement) {
                echo "<br>Cannot parse the following command: " . $cmdstr . "<br>";
                $e = OCI_Error($db_conn); // For OCIParse errors pass the connection handle
                echo htmlentities($e['message']);
                $success = False;
            }

            $r = OCIExecute($statement, OCI_DEFAULT);
            if (!$r) {
                echo "<br>Cannot execute the following command: " . $cmdstr . "<br>";
                $e = oci_error($statement); // For OCIExecute errors pass the statementhandle
                echo htmlentities($e['message']);
                $success = False;
            }

            return $statement;
        }
        function printResult($result, $num_att) { //prints results from a select statement
            while ($row = OCI_Fetch_Array($result, OCI_BOTH)) {
                echo "<tr>";
                for($i=0; $i < $num_att; $i++) {
                    echo "<td>" . $row[$i] . "</td>";
                }
                echo "</tr>";
            }
        }

        function printProjection($attr_arr, $table) { //prints results from a select statement
            
            $goodattrs = [];

            foreach ($attr_arr as $attr) {
                if ($attr != "None") {
                    $goodattrs[] = $attr;
                }
            }
            $columns = implode(',', $goodattrs);
            $valid = validateColumns($table, $goodattrs);
            if ($valid) {
                echo "<br> Retreiving data from $table<br>";
                echo "<table>";
                echo "<tr>";
                foreach ($goodattrs as $attr) {
                    echo "<th>$attr</th>";
                }
                $result = executePlainSQL("SELECT $columns FROM $table");
                tablePrint($result, count($goodattrs));
            } else {
                echo " Please try again with a valid selection.";
            }
        }


        function printSelection($result, $attr_arr, $table, $comp_arr) {

            $goodattrs = [];

            foreach ($attr_arr as $attr) {
                if ($attr != "None") {
                    $goodattrs[] = $attr;
                }
            }

            $attrs = implode(',', $attr_arr);

            $selectClause = implode(',', $goodattrs);
            $valid = validateColumns($table, $goodattrs);
            if ($valid) {
                $where = makeWhereString($comp_arr, $attr_arr);
                $whereClause = implode(' AND ', $where);

                echo "<br> Retreiving data from $table<br>";
                echo "<table>";
                echo "<tr>";
                foreach ($goodattrs as $attr) {
                    echo "<th>$attr</th>";
                }
                $result = executePlainSQL("SELECT $selectClause FROM $table WHERE $whereClause");
                tablePrint($result, count($goodattrs));
            } else {
                echo "Please try again with a valid selection.";
            }
        }

        function makeWhereString($comp, $attr) {
            
            // single quoted comp arr to use in query
            $quotedComp = array_map(function ($value) {
                return "'" . $value . "'";
            }, $comp);
            $commaSeparatedComp = implode(',', $quotedComp);

            $where = [];
                for ($i=0; $i < 5; $i++) {
                    if ($comp[$i] != "" && $attr[$i] != "None") {
                        $where[] = $attr[$i] . "=" . $quotedComp[$i];
                    }
                }

            return $where;

        }

        function tablePrint($result, $num_att) { //prints results from a select statement
            while ($row = OCI_Fetch_Array($result, OCI_BOTH)) {
                echo "<tr>";
                for($i=0; $i < $num_att; $i++) {
                    echo "<td>" . $row[$i] . "</td>";
                }
                echo "</tr>";
            }
            echo "</table>";
        }

        function validateColumns($table, $attr_arr) {
            $valid = true;
            $invalidColumn = "";
            $result = executePlainSQL("SELECT * FROM $table");

            while ($row = OCI_Fetch_Array($result, OCI_ASSOC)) {

                for($i=0; $i < count($attr_arr); $i++) {
                    $attr =  $attr_arr[$i];
                        if (!isset($row[$attr])) {
                        $invalidColumn = $attr;
                        $valid = false;
                        break;
                    }
                }
            if ($valid) {
                return $valid;
            } else {
                echo "There is no " . $invalidColumn . " in " . $table . ".";
                return $valid;
            }
        }
    }

        function connectToDB() {
            global $db_conn;

            $db_conn = OCILogon("ora_asamra02", "a55296388", "dbhost.students.cs.ubc.ca:1522/stu");
            if ($db_conn) {
                // debugAlertMessage("Database is Connected");
                return true;
            } else {
                debugAlertMessage("Cannot connect to Database");
                $e = OCI_Error(); // For OCILogon errors pass no handle
                echo htmlentities($e['message']);
                return false;
            }
        }
        function disconnectFromDB() {
            global $db_conn;

            debugAlertMessage("Disconnect from Database");
            OCILogoff($db_conn);
        }
        function handleRequest() {
            if (connectToDB()) {
                if (array_key_exists('project-selectQueryRequest', $_GET)) {
                    handlePSRequest();
                }
                disconnectFromDB();
            }
        }
        if (isset($_GET['project-select'])) {
            handleRequest();
        }
    ?>
</html>